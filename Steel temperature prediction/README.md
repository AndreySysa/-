# Предсказание температуры стали.

[HTML](https://github.com/AndreySysa/Portfolio/blob/main/Steel%20temperature%20prediction/Steel%20temperature%20prediction.html)     [ipynb](https://github.com/AndreySysa/Portfolio/blob/main/Steel%20temperature%20prediction/Steel%20temperature%20prediction.ipynb)[^1]


Перед нами стояла задача: 
- для металлургического комбината построить модель, которая предскажет температуру стали.
***
Нам были предоставлены:
- Краткое описание этапа обработки стали.
- Данные, состоящие из файлов формата `csv`, полученных из разных источников:
- - `data_arc_new.csv` — данные об электродах;
- - `data_bulk_new.csv` — данные о подаче сыпучих материалов (объём);
- - `data_bulk_time_new.csv` — данные о подаче сыпучих материалов (время);
- - `data_gas_new.csv` — данные о продувке сплава газом;
- - `data_temp_new.csv` — результаты измерения температуры;
- - `data_wire_new.csv` — данные о проволочных материалах (объём);
- - `data_wire_time_new.csv` — данные о проволочных материалах (время).

Во всех файлах столбец `key` содержит номер партии.
***
Был составлен приблизительный план работы:

1. Описание проекта, задачи
​
2. Изучение и подготовка данных:
- Выгрузка данных
- Анализ данных
- Описание данных
​
3. Предобработка данных:
- Проверка типов данных
- Работа с пропусками
​
4. Подготовка данных:
- Проверка на мультиколлинеарность
- Формирование итоговых датафреймов
- Формирование признаков
- Формирование выборок
​
5. Обучение моделей.
​
6. Тестирование модели.
​
7. Итоговый вывод.
***
Для выполнения поставленной задачи использовались следующие библиотеки и модули:
- os: модуль для работы с операционной системой (файлы и папки)
- optuna: библиотека для оптимизации гиперпараметров моделей
- numpy: библиотека для работы с многомерными массивами и математическими функциями
- pandas: библиотека для работы с данными в виде таблиц (DataFrame)
- seaborn: библиотека для визуализации данных
- plotly.express: библиотека для создания интерактивных графиков и визуализаций
- matplotlib.pyplot: библиотека для создания статических графиков и визуализаций
- time: модуль для работы со временем
- sklearn.svm.SVR: класс для обучения модели методом опорных векторов (Support Vector Regression)
- lightgbm.LGBMRegressor: класс для обучения градиентного бустинга на деревьях (LightGBM)
- catboost.CatBoostRegressor: класс для обучения градиентного бустинга на деревьях (CatBoost)
- sklearn.dummy.DummyRegressor: класс для обучения простых базовых моделей (Dummy)
- sklearn.pipeline.make_pipeline: функция для создания конвейера из нескольких этапов обработки данных и моделей
- sklearn.preprocessing.StandardScaler: класс для стандартизации данных (Standardization)
- sklearn.linear_model.LinearRegression: класс для обучения линейной регрессии
- sklearn.ensemble.RandomForestRegressor: класс для обучения случайного леса (Random Forest)
- sklearn.model_selection.train_test_split: функция для разделения данных на обучающую и тестовую выборки
- sklearn.metrics.mean_absolute_error: функция для вычисления средней абсолютной ошибки (Mean Absolute Error)
- sklearn.model_selection.KFold: класс для разделения данных на фолды в кросс-валидации (KFold)
- sklearn.model_selection.cross_val_score: функция для оценки модели с использованием кросс-валидации
***
По требованиям заказчика.
- был зафиксирован параметр установки начального состояния генератора псевдослучайных чисел `RANDOM_STATE = 140823`
- целевая метрика $МАЕ\ngtr 6.8$
***
В ходе ознакомления с данными было установлено:
1. `df_arc`
Данные содержат информацию о начале и конце нагрева дугой, а также активной и реактивной мощности для каждого ключевого значения. Всего в данных содержится 14876 записей.
Типы данных в столбцах : 
- ключ - целочисленный,
- время начала и конца нагрева - объект,
- мощности - числовые значения.
Пропущенные значения отсутствуют.
2. `df_bulk`
Данные содержат информацию о добавлении сыпучих материалов в процессе обработки. Всего в данных содержится 3129 записей. В столбцах `Bulk 1`...`Bulk 15` указаны объемы добавленных материалов для каждого ключевого значения.

В данных имеются пропущенные значения для большинства столбцов, что означает, что не все материалы были добавлены для каждого ключевого значения.

3. `df_bulk_time`
В таблице представлены данные о времени подачи сыпучих материалов. Всего в таблице 3129 строк и 16 столбцов, как и в `df_bulk`. В столбце `key` указан ключ для каждой записи. В столбцах `Bulk 1`...`Bulk 15` указаны временные метки для выполнения операций `Bulk`. Некоторые столбцы содержат пропущенные значения. Для `key` выполнены несколько операций `Bulk`, для разных`key` разные и в рвзных количествах. (`Bulk 14` выполнялся 2806 раз, а `Bulk 8` - 1)
Данные в столбцах `Bulk 1`...`Bulk 15` представлены в формате object.

4. `df_gas`
Данные предоставляют информацию о продувке сплава газом. Набор данных содержит 3239 строк и 2 столбца: `key` и `Газ 1`. Столбец `key` представляет собой номер партии, а столбец `Газ 1` содержит числовые значения, отражающие объем газа для продувки. Оба столбца имеют правильные типы данных.

5. `df_temp`
Данные из файла содержат информацию о замерах температуры в разных моментах времени. В наборе данных представлено 18092 строк и 3 столбца:
- `key` - номер партии,
- `Время замера` - дата и время проведения замера,
- `Температура` - числовое значение температуры.

Столбец `key` представляет собой уникальный идентификатор, который, используется для связи с другими таблицами. Столбец `Время замера` содержит информацию о точной дате и времени проведения замера температуры. Столбец `Температура` содержит числовые значения, отражающие измеренную температуру.

Столбец `Температура` содержит недостающие значения (`NaN`) в некоторых строках (14665 непустых значений из 18092).

6. Информация о точной дате и времени имела тип данных `object` и была преобразована в тип `datetime` для дальнейшего анализа.
***
В ходе предобработки данных было установлено:
1. В `df_arc` записи с `2019-05-03 11:02:14` по `2019-09-06 17:26:15`, количество партий - `3214` (проводилась повторная обработка и по этому количество записей - `14876`).

2. `Активная мощность` от `0.223120` до `1.463773`. `Реактивная мощность` от `-715.479924` до `1.270284`. Отрицательное значение одно и выглядело не логично, имело более высокий порядок(e+02, остальные значения в интервале e-01 - e+00). 

3. Между активной и реактивной мощностью была установлена высокая положительная корреляция(0.97). Что позволило исправить некорректное значение реактивной мощности, заменив его на произведение "Активной мощности" на среднюю пропорцию "Реактивной мощности" к "Активной мощности". 

4. Анализируя данные по количеству обработок и партий на сталелитейном заводе, были сделаны следующие наблюдения:
- Большинство партий (51.37%) прошли 4 или 5 обработок.
- Примерно треть партий (32.75%) прошли 3, 6 или 7 обработок.
- Оставшиеся партии (15.88%) были подвергнуты 2, 8, 9, 10 или более обработкам.
- Партии с 10 и более обработками составляют менее 1% от общего количества партий.

Таким образом, основная часть партий на сталелитейном заводе проходит 4 или 5 обработок, а среднее количество обработок для одной партии : 4.63.

5. В промежуток с 13 по 18 июля отсутствуют записи в данных.(скорее всего или авария или ремонт оборудования - что-то от чего производство не работало)

6. В среднем процесс нагрева электродами длится около 3,5 минут, минимальная продолжительность обработки составляет 11 секунд, максимальная - чуть больше 15 минут.

7. Мы вычислили потребляемую энергию, умножив продолжительность дуги в секундах (разность времени окончания дуги и времени ее начала) на полную мощность ($S$).
8. ![формула](https://latex.codecogs.com/svg.image?S=\sqrt{P^2&plus;Q^2})
Где:
- $S$ — полная мощность;
- $P$ — активная мощность;
- $Q$ — реактивная мощность.
8. Объём подачи сыпучих материалов различается в зависимости от партии. Для `Bulk 8` только одна партия была зарегистрирована, для `Bulk 14` - `2806`.

Средние значения объёма подачи сыпучих материалов варьируются от `39.24` до `305.6`.

Стандартное отклонение объёма подачи сыпучих материалов находится в диапазоне от `18.28` до `191.02`, что говорит о разбросе данных внутри каждой партии.

Минимальные значения объёма подачи сыпучих материалов составляют от `6` до `49`, а максимальные значения — от `185` до `772`, что указывает на значительную разницу между минимальными и максимальными значениями внутри каждой партии.

Медианные значения объёма подачи сыпучих материалов колеблются от `31` до `298`.

Значения в первом квартиле (`25%`) варьируются от `27` до `406`, а в третьем квартиле (`75%`) — от `46` до `205`, что указывает на наличие большого разброса данных и значительные отличия между нижними и верхними квартилями.

В целом, данные о подаче сыпучих материалов (объем) показывают значительную вариабельность внутри каждой партии и различия между партиями, что связано с широким ассортиментом выпускаемой продукции (различными условиями производства и требованиями процесса).

9. В столбцах `Bulk_5` и `Bulk_12`  таблицы `data_bulk_new.csv` выявлены единичные случаи, когда значения сильно выбиваются из общей картины (аномалии).

10. Признаки `Bulk_1` - `Bulk_15` таблицы `data_bulk_time_new.csv` заменили на длительность процесса подачи сыпучих материалов (так более информативно)

11. Максимальная длительность обработки одной партии стали с применением сыпучих материалов составляет 13683 с (около 4 часов).

12. Таблица `data_gas_new.csv` содержит 3239 наблюдений (количество партий), а данные об электродах - 3214. Среднее значение количества газа составляет примерно 11. Стандартное отклонение равно приблизительно 6.22, что указывает на относительно высокую вариацию значений. Минимальное значение количества газа составляет 0.008399, а максимальное значение равно 77.995040. Первый квартиль (25%) равен 7.043089, медиана (50%) составляет 9.836267, а третий квартиль (75%) равен 13.769915.

Исходя из этой информации сделан вывод, что измерения количества газа имеют широкий диапазон значений с примерным средним значением 11.002062. Наличие относительно высокого стандартного отклонения указывает на значительную изменчивость значений количества газа. Партий металла обработанных газом больше, чем расплавленных электродами. (особенность технологии)

13. Таблица `data_temp_new.csv` содержит количество партий 3216 (количество уникальных записей в столбце key) не соотносится ни с одной из таблиц, но номера партий доходят до 3241 как в данных о продувке сплава газом. Количество дубликатов в столбце с номером партии - 14876 из 18092 строк.

14. Обнаружены пять значений температур, которые выбиваются из общей массы: 1191, 1204, 1208, 1218, 1227. Такие температуры более свойственные для закалки и не соответствуют технологическому процессу.

15. Большинство партий имели `6` или `5` замеров температур (соответственно `27.74%` и `23.6%` всех партий). 

Партии с количеством замеров `4` и `3` составляют значительную долю (соответственно `16.17%` и `5.41%`). 

Партии с количеством замеров `7` и `8` составляют значительную долю (соответственно `15.24%` и `6.37%`).

Партии, в которых делали более `8` замеров, составляют меньшую долю (всего около `4%` всех партий). Такое количество замеров требуется только в особых случаях.

Партии с количеством замеров `1` или выше `11` составляют незначительную долю (всего `0.31%` всех партий).

Таким образом, стандартное количество замеров температур в партии составляет 5-6 и оно является наиболее распространенным. Все значения за пределами этого диапазона можно считать исключениями или особыми случаями. Удалили строки, где количество замеров меньше двух.

16. В целом, `Wire 1`, `Wire 2` и `Wire 3` имеют большое количество данных (3055, 1079 и 63 наблюдения соответственно), в то время как количество данных для `Wire 4`- `Wire 9` намного меньше. Различия в средних значениях и стандартных отклонениях между проволоками указывают на разные характеристики и свойства этих материалов.

`Wire 6` использовали только один раз.

17. Признаки `Wire 1` - `Wire 15` таблицы 'data_wire_time_new.csv'` заменили на длительность процесса подачи проволочных материалов (так более информативно).

18. Максимальная длительность обработки одной партии стали с применением проволочных материалов составляет 5937 с (около 1,6 часа).

19. Заменили пропуски в предоставленных таблицах на нули, так как они связаны с особенностями технологии.

20. Названия столбцов в таблицах перевили на английский и привели к "змеиному" шрифту.

21. В ходе предобработки данных были добавлены новые признаки:
- реактивная мощность
- потребляемая энергия
- продолжительность дуги
- количество этапов обработки
- общий объем добавок (сыпучих материалов)
- общий объем добавок (проволочных материалов)
- начало подачи сыпучих материалов
- конец подачи сыпучих материалов
- начало подачи проволочных материалов
- конец подачи проволочных материалов
- время первого замера температуры
- время последнего замера температуры
- температура при первом замере
- температура при последнем замере
- время между первым и последним замером температуры

22. Данные в таблицах были агрегированны по ключу.

23. В ходе проведения анализа данных были выявлены моменты, которые уточнялись и согласовывались с представителем заказчика (Был составлен список вопросов)
***
Список Вопросов:

1. Уточнение целевого признака. 
2. Метрика.
3. Почему отсутствуют записи в данных (`data_arc_new.csv` — данные об электродах) за промежуток с 13 по 18 июля.
4. По `data_bulk_new.csv` — данные о подаче сыпучих материалов (объём):
- `Bulk 1`...`Bulk 15` - это разные материалы?
- `Bulk 8` действительно использовали один раз за период с 2019-05-03 по 2019-09-06?
- `Bulk 5` имеет одно значение `603` при условии, что значения, привышающие максимум (лежат за границей выброса) распределения: `234`, `242`, `256`, `293`. Это нормально?
- `Bulk 12` имеет одно значение `1849` при условии, что значения, привышающие максимум (лежат за границей выброса) распределения:  `496` - `853`. Это нормально?
5. Почему партий продутых больше, чем нагретых электродами?
6. Могут-ли быть перепутаны номера партий?
7. Пять значений температур, которые выбиваются из общей массы: 1191, 1204, 1208, 1218, 1227. В чем причина таких показателей? (остыл ковш, неисправность измерительной аппаратуры) Укладываются они в рамки технологии, или это аномалии?
8. Нужен-ли нагрев (по технологии) выше [температуры](https://latex.codecogs.com/svg.image?&space;1600^{\circ}C)?
***
После уточнения информациии дообработали таблички. (удалили редкие (единичные) случаи и аномальные значения.
***
Составили окончательную таблицу для обучения моделей, объеденив все таблицы и включая только те партии, для которых доступна информация по каждому этапу подготовки сплава. Причина такого выбора состоит в том, что каждая партия проходит все этапы подготовки.

Так как целевым признаком является последняя измеренная температура, проверили, чтоб после последнего измерения температуры больше не каких манипуляций со сплавом не производилось. После этого удалили столбцы с типом данных `datetime`.

Тот факт, что между активной и реактивной мощностью высокая положительная корреляция был нами отмечен в самом начале обработки даных, была вычеслена полная мощность, которая объединяет оба этих параметра. Мы вычисляли продолжительность дуги и умножая на полную мощность определяли потребляемую энергию. Таким образом потребляемая энергия объединяет все четыре параметра. Оставим только потребляемую энергию, чтоб не создавать лишних связей между параметрами и не путать модель.

Сделали визуализацию корреляции  сильно коррелирующих переменных. Из неё видно, что некоторые переменные имеют высокую корреляцию между собой. Например, `energy_consumption` имеет высокую корреляцию с `count_arc` (0.71) и `bulk_sum` (0.5), `bulk_sum` в свою очередь сильно коррелирует с `bulk_12` (0.87). Удалили `count_arc` и `bulk_sum`.

Видна тесная взаимосвязь `bulk_7`-`wire_4` и `bulk_9`-`wire_8`.

Такая высокая корреляция может указывать на наличие мультиколлинеарности между этими переменными. Мультиколлинеарность может внести нестабильность и неоднозначность в регрессионные модели, и затруднить интерпретацию важности каждой переменной.

Для избавления от мультиколлинеарности объеденили попарно `bulk_7`-`wire_4` и `bulk_9`-`wire_8`.
После чего появилась корреляция между `bulk_7_wire_4` и `bulk_2`. Объеденили их, создав bulk_7_wire_4_bulk_2.

Прямой зависимости целевого признака от какого-либо параметра нет. Без построения модели нельзя сказать от чего зависит температура на заключительном этапе.
***
Для обучения моделей подготовили выборки (обучающую и тестовую c разбивкой $\frac{2}{3}$ и $\frac{1}{3}$ соответственно). 

Выделили целевой признак и функциональные признаки.

Так как признаки имеют разную размерность обучаили и провели стандартизацию на тренировочных данных, а затем провели ту же стандартизацию на тестовых данных.

Вычислили среднюю абсолютную ошибку (MAE=7.88) для модели, которая всегда предсказывает среднее значение целевой переменной. Получили таким образом базовую метрику для сравнения с другими моделями. Это позволило оценить, насколько хорошо другие модели справляются с прогнозированием по сравнению с этой "наивной" моделью.

Cоздали объект `KFold` для разделения датасета для кросс-валидации.

- LinearRegression() (линейная регрессия) выдала $МАЕ = 6.55$
- Случайный лес RandomForestRegressor - $МАЕ = 6.43$
- Градиентный бустинг LightGBM - $МАЕ = 6.25$
- Градиентный бустинг CatBoostRegressor - $МАЕ = 6.28$
- Support Vector Regression - $МАЕ = 6.42$

Для подбора гиперпараметров моделей использовали библиотеку для автоматической оптимизации параметров модели `Optuna`. Производили подбор поэтапно уменьшая интервалы параметров для подбора, используя для этих целей визуализацию (таблицы с параметрами моделей, показавших лучшую метрику при подборе параметров, графики важности гиперпараметров, графики истории оптимизации и графики контура для разных параметров)

Все модели показали метрику лучше, чем "наивная" модель. Более того они удовлетворяют требованиям заказчика $МАЕ\ngtr 6.8$
***
С целью выбора наилучшей модели провели визуализацию значений полученных метрик на кросс-валидации.
Лучшая - LGBMRegressor с параметрами:
- `colsample_bytree` : `0.7`,
- `learning_rate` : `0.09`,
- `max_depth` : `2`, 
- `min_child_samples` : `7`,
- `n_estimators` : `276`,
- `random_state` : `140823`, 
- `subsample` : `0.76`
***
Проведено тестирование лучшей модели (на отложеной выборке). Получена $МАЕ = 6.62$, что удовлетворяют требованиям заказчика $МАЕ\ngtr 6.8$. Дополнительно было проведено сравнение с простой моделью регрессии DummyRegressor, выдавшей $МАЕ = 8.69$.

Результаты тестирования показали, что нам удалось создать достойную модель, удовлетворяющую требованиям заказчика.
***
Было проведено исследование степени влияния признаков на целевой показатель.

**На основе анализа важности признаков можно сделать следующие выводы:**
- Наибольшую важность для целевой переменной имеют признаки:
- - `temperature_first_measurement` - температура в начале процесса обработки.
- - `energy_consumption` - потребляемая в процессе обработки энергия.
- - `time_between_measurements` - сумарное время нагрева.
**Эти признаки оказывают наибольшее влияние на предсказание целевой переменной.*

- *Существенно влияют на целевую переменную:*
- - `bulk_14` - сыпучий материал.
- - `wire_1` - проволочный материал.
- - `gas_quantities` - количество газа для продувки.
- - `duration_bulk` - сумарное время подачи сыпучих материалов.
- - `bulk_12` - сыпучий материал.
- - `wire_sum` - общее количество подаваемых проволочных материалов.
- - `bulk_6` - сыпучий материал.
- - `wire_2` - проволочный материал.
- - `bulk_15` - сыпучий материал.
- - `bulk_3` - сыпучий материал.
- - `duration_wire` - сумарное время подачи проволочных материалов.
- - `bulk_1` - сыпучий материал.
- - `bulk_4` - сыпучий материал.
- - `bulk_11` - сыпучий материал.

- *Мало Влияющие:*
- - `bulk_10` - сыпучий материал.
- - `wire_6` - проволочный материал.
- - `bulk_5` - сыпучий материал.
- -	`bulk_7` - сыпучий материал.
- - `wire_4` - проволочный материал.
- -	`bulk_2` - сыпучий материал.
- -	`wire_3` - проволочный материал.

- *Не оказывают влияния:*
- - `bulk_9`, `bulk_13` - сыпучие материалы.
- - `wire_7`,	`wire_8`,	`wire_9` - проволочные материалы.

Таким образом, наиболее важные признаки для предсказания целевой переменной включают температуру первого измерения, потребление энергии, время обработки, данные о некоторых веществах и проволоке.


[^1]:Для корректного просмотра Jupyter notebook с работающим содержанием, пожалуйста, используйте следующую ссылку:
[nbviewer](https://nbviewer.jupyter.org/github/AndreySysa/Portfolio/blob/main/Steel%20temperature%20prediction/Steel%20temperature%20prediction.ipynb)
Просто кликните на ссылку, и nbviewer отобразит notebook с интерактивными ссылками.

